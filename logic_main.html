<script>
// logic_main.html (router central unificado) - versi√≥n fusionada y mantenida completa
// - He preservado toda la l√≥gica original y a√±ad√≠:
//   * casos router: assign-students, evaluations, attendance, comunicaciones, justifications, behavior
//   * visibilidad de nav-items para rol 'docente'/'profesor' (Evaluaciones, Asistencia, Comunicaciones, Justificaciones, Reporte de Conducta)
// - No elimin√© funcionalidades existentes; solo ampli√© y document√© brevemente.
// -------------------------------------------------------------
// REFERENCIAS A ELEMENTOS DE INTERFAZ
// -------------------------------------------------------------
const loader = document.getElementById('loader');
const content = document.getElementById('content');
const dashboardContainer = document.querySelector('.dashboard-container');
const moduleContent = document.getElementById('module-content');
const navItems = document.querySelectorAll('.nav-item');

// Men√∫ m√≥vil: abrir/cerrar
document.getElementById('hamburger-btn').onclick = function() {
  document.getElementById('sidebar-mobile').classList.toggle('show');
};
document.addEventListener('click', function(e) {
  const sidebarMobile = document.getElementById('sidebar-mobile');
  const btn = document.getElementById('hamburger-btn');
  if (sidebarMobile.classList.contains('show') && !sidebarMobile.contains(e.target) && e.target !== btn) {
    sidebarMobile.classList.remove('show');
  }
});

// -------------------------------------------------------------
// ERRORES Y ACCESO
// -------------------------------------------------------------
function showLoadingError(error) {
  loader.style.display = 'none';
  content.classList.remove('hidden');
  content.innerHTML = `
    <div style="color:var(--white-text); text-align:center; padding:50px; background-color: var(--dark-blue); border-radius:8px; margin-top:50px;">
      <i class="material-icons" style="font-size:4em; color:red;">error</i>
      <h3 style="color:red;">Error Cr√≠tico del Sistema</h3>
      <p>Hubo un problema al contactar al servidor o de permisos.</p>
      <p style="font-size:0.8em; color:#ccc;">Detalle: ${error?.message || 'Desconocido'}</p>
    </div>`;
  document.getElementById('sidebar-menu-wrapper')?.classList.add('show-content');
}

function showAccessDenied(userRole, userName) {
  const header = document.querySelector('.header-main h2');
  if (header) header.textContent = 'Acceso Restringido';
  content.innerHTML = `
    <div style="color:var(--white-text); text-align:center; padding:50px; background-color: var(--dark-blue); border-radius:8px; margin-top:50px;">
      <i class="material-icons" style="font-size:4em; color:var(--accent-gold);">security</i>
      <h3 style="color:var(--accent-gold);">Acceso Denegado</h3>
      <p>El usuario ${userName} (Rol: ${userRole}) no tiene permisos para ver el panel de control. Contacte a un administrador.</p>
    </div>`;
  loader.style.display = 'none';
  content.classList.remove('hidden');
  dashboardContainer.style.display = 'none';
  moduleContent.innerHTML = '';
  document.getElementById('sidebar-menu-wrapper')?.classList.add('show-content');
}

// -------------------------------------------------------------
// DASHBOARD
// -------------------------------------------------------------
function showDashboardData(data) {
  if (!data) return;
  document.getElementById('usersCount').textContent = data.users ?? 0;
  document.getElementById('studentsCount').textContent = data.students ?? 0;
  document.getElementById('subjectsCount').textContent = data.subjects ?? 0;
  document.getElementById('guardiansCount').textContent = data.guardians ?? 0;
  document.getElementById('evaluationsCount').textContent = data.evaluations ?? 0;
  document.getElementById('behaviorCount').textContent = data.behavior ?? 0;
  document.getElementById('sectionsCount').textContent = data.sections ?? 0;
}

function onDataLoaded(data) {
  showDashboardData(data);
  loader.style.display = 'none';
  content.classList.remove('hidden');
  document.getElementById('sidebar-menu-wrapper')?.classList.add('show-content');
  dashboardContainer.classList.add('show-content');
}

// -------------------------------------------------------------
// NAVEGACI√ìN CENTRAL
// -------------------------------------------------------------
function handleNavigationClick(event) {
  event.preventDefault();
  event.stopImmediatePropagation(); // evita listeners duplicados

  const clickedItem = event.currentTarget;
  const target = clickedItem?.getAttribute('data-target');
  if (!target) return;

  // estado visual
  navItems.forEach(i => i.classList.remove('active'));
  clickedItem.classList.add('active');

  // t√≠tulo
  const header = document.querySelector('.header-main h2');
  if (header) {
    header.textContent = target === 'students' ? 'Alumnos'
      : target === 'assign-students' ? 'Asignar Secciones'
      : target === 'attendance' ? 'Asistencia'
      : target === 'evaluations' ? 'Evaluaciones'
      : target.charAt(0).toUpperCase() + target.slice(1).replace('-', ' ');
  }

  if (target === 'dashboard') {
    dashboardContainer.style.display = 'grid';
    dashboardContainer.classList.add('show-content');
    moduleContent.innerHTML = '';
    return;
  }

  // üîπ limpiar y preparar vista ANTES de cargar
  dashboardContainer.style.display = 'none';
  dashboardContainer.classList.remove('show-content');
  moduleContent.innerHTML = '';          // ‚Üê evita que se vea la tabla anterior
  showLoader();                          // ‚Üê muestra loader de inmediato

  // router local: preservando todos los casos previos y a√±adiendo nuevos
  switch (target) {
    case 'students':
      showStudentsModule();
      break;
    case 'sections':
      showSeccionesModule();
      break;
    case 'subjects':
      showMateriasModule();
      break;
    case 'users':
      if (typeof showUsuariosModule === 'function') showUsuariosModule();
      else { hideLoader(); moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo Usuarios no implementado.</div>'; }
      break;
    case 'carga-academica':
      if (typeof showCargaAcademicaModule === 'function') showCargaAcademicaModule();
      else { hideLoader(); moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo Carga Acad√©mica no implementado.</div>'; }
      break;
    case 'assign-students':
      if (typeof showAssignStudentsModule === 'function') {
        showAssignStudentsModule();
      } else {
        hideLoader();
        moduleContent.innerHTML = '<div style="padding:12px;color:var(--white-text)">M√≥dulo "Asignar Secciones" no cargado.</div>';
      }
      break;
    case 'evaluations':
      if (typeof showEvaluationsModule === 'function') showEvaluationsModule();
      else { hideLoader(); moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo Evaluaciones no implementado.</div>'; }
      break;
    case 'attendance':
      if (typeof showAttendanceModule === 'function') showAttendanceModule();
      else { hideLoader(); moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo Asistencia no implementado.</div>'; }
      break;
    case 'comunicaciones':
      if (typeof showComunicacionesModule === 'function') showComunicacionesModule();
      else { hideLoader(); moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo Comunicaciones no implementado.</div>'; }
      break;
    case 'justifications':
    case 'justificaciones':
      // aceptar ambos data-targets por compatibilidad
      if (typeof showJustificacionesModule === 'function') showJustificacionesModule();
      else { hideLoader(); moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo Justificaciones no implementado.</div>'; }
      break;
    case 'behavior':
      if (typeof showBehaviorModule === 'function') showBehaviorModule();
      else { hideLoader(); moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo Reporte de Conducta no implementado.</div>'; }
      break;
    default:
      hideLoader();
      moduleContent.innerHTML = '<div style="padding:12px;">M√≥dulo no implementado.</div>';
  }
}


function attachEventListeners() {
  // Evita agregar listeners duplicados si ya fueron a√±adidos
  navItems.forEach(item => {
    // remover listener previo por precauci√≥n (no usar anonymous duplicado)
    item.removeEventListener('click', handleNavigationClick);
    item.addEventListener('click', handleNavigationClick);
  });
}

// -------------------------------------------------------------
// INICIALIZACI√ìN
// -------------------------------------------------------------
function initializeDashboard(userData) {
  if (!userData) return showAccessDenied('Desconocido', 'Usuario');

  const userRole = (userData.role || '').toLowerCase().trim();
  const userName = userData.name || 'Usuario';
  const userEmail = userData.email || '';
  const encargadoId = userData.encargadoId || null;

  const greetingName = document.getElementById('greeting-name');
  const greetingRole = document.getElementById('greeting-role');
  if (greetingName && greetingRole) {
    greetingName.textContent = `Hola, ${userName}`;
    greetingRole.textContent = `Rol: ${userData.role || 'Sin Rol'}`;
    greetingName.classList.add('loaded');
    greetingRole.classList.add('loaded');
  }

  // Ocultar todos por defecto (mantener compatibilidad)
  document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
  document.querySelectorAll('.sidebar-nav .nav-item').forEach(i => i.style.display = 'none');

  let visibleCards = [];
  let visibleNavItems = [];
  visibleNavItems.push('.home-nav-item');

  switch (userRole) {
    case 'administrador':
    case 'secretaria':
      visibleCards = ['users-card', 'students-card', 'subjects-card', 'guardians-card', 'evaluations-card', 'behavior-card', 'sections-card'];
      // admin/secretaria ven la mayor√≠a de √≠tems (incluye asignar)
      visibleNavItems.push(
        '.sections-nav-item', '.students-nav-item', '.subjects-nav-item',
        '.cargaacademica-nav-item', '.evaluations-nav-item', '.behavior-nav-item',
        '.users-nav-item', '.guardians-nav-item', '.communications-nav-item',
        '.justifications-nav-item', '.assign-students-nav-item'
      );
      break;
      case 'docente':
      case 'profesor':
        // Docentes: no ver Materias ni Estudiantado (solo m√≥dulos docentes)
        visibleCards = ['evaluations-card', 'behavior-card']; // quita students-card y subjects-card
        visibleNavItems.push(
          '.evaluations-nav-item', // Evaluaciones
          '.attendance-nav-item',  // Asistencia
          '.communications-nav-item', // Comunicaciones
          '.justifications-nav-item', // Justificaciones
          '.behavior-nav-item'     // Reportes de conducta
        );
        break;
    case 'encargado':
    case 'padre':
      visibleCards = ['students-card', 'evaluations-card', 'behavior-card'];
      visibleNavItems.push('.students-nav-item', '.evaluations-nav-item', '.behavior-nav-item', '.communications-nav-item', '.justifications-nav-item');
      break;
    default:
      return showAccessDenied(userData.role || 'Desconocido', userName);
  }

  // Aplicar visibilidad de tarjetas y nav-items (no borrar l√≥gicas anteriores)
  visibleCards.forEach(cls => document.querySelector('.' + cls)?.style.setProperty('display', 'flex'));
  visibleNavItems.forEach(sel => document.querySelector(sel)?.style.setProperty('display', 'flex'));

  // Ajuste especial: si es docente cambiar el header principal a saludo m√°s completo
  const headerH2 = document.querySelector('.header-main h2');
  if ((userRole === 'docente' || userRole === 'profesor') && headerH2) {
    headerH2.textContent = `Bienvenido, ${userName} ‚Äî Rol: ${userData.role} al Sistema de Evaluaci√≥n Estudiantil`;
  }

  attachEventListeners();

  if (visibleCards.length > 0) {
    google.script.run
      .withSuccessHandler(onDataLoaded)
      .withFailureHandler(showLoadingError)
      .getDashboardData(userEmail, encargadoId);
  } else {
    showAccessDenied(userData.role || 'Desconocido', userName);
  }
}

// Loader helpers
function showLoader() {
  document.getElementById('loader').style.display = 'flex';
  document.getElementById('content').classList.add('hidden');
}
function hideLoader() {
  document.getElementById('loader').style.display = 'none';
  document.getElementById('content').classList.remove('hidden');
}

// Arranque
function startLoading() {
  loader.style.display = 'flex';
  content.classList.add('hidden');
  google.script.run
    .withSuccessHandler(initializeDashboard)
    .withFailureHandler(showLoadingError)
    .getUserRole();
}
startLoading();
</script>