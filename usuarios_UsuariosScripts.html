<script>
  //  Estado global del m贸dulo
// Variables globales para gestionar el estado de la aplicaci贸n
let usuariosOriginales = []; // Almacena la lista original de usuarios
let usuariosFiltrados = []; // Almacena los usuarios filtrados por b煤squeda
let modalContext = null; // Contexto global para el modal de asignaci贸n de materias
/**
 * Recopila los datos del formulario de edici贸n en el modal y los env铆a al servidor
 * para actualizar el registro del usuario.
 */
function actualizarUsuario() {
    const originalEmail = document.getElementById('modalOriginalEmail')?.value;
    const nuevoNombre = document.getElementById('modalNombre')?.value;
    const rol = document.getElementById('modalRol')?.value;
    
    // Recopilar los accesos del contenedor de tags (solo para roles que los usan)
    let accesosString = '';
    if (rol !== 'Encargado') {
        const accesosTags = document.querySelectorAll('#modalAccesosTags .acceso-tag');
        const accesosArray = Array.from(accesosTags).map(tag => tag.textContent.trim().replace('x', ''));
        accesosString = accesosArray.join(', ');
    }

    // Validar que el nombre no est茅 vac铆o
    if (!nuevoNombre.trim()) {
        Swal.fire({
            icon: 'error',
            title: 'Nombre Requerido',
            text: 'Por favor, introduce un nombre para el usuario.'
        });
        return;
    }

    mostrarModalCarga();
    
    const datosActualizados = {
        originalEmail: originalEmail,
        nuevoNombre: nuevoNombre,
        nuevosAccesos: accesosString,
        rol: rol
    };

    google.script.run
        .withSuccessHandler(function(respuesta) {
            ocultarModalCarga();
            if (respuesta.success) {            
            // Cerrar el modal despu茅s de una actualizaci贸n exitosa
                document.getElementById('modalEdicionUsuario').style.display = 'none';
            // Usar SweetAlert para mostrar la respuesta del servidor
            Swal.fire({
                icon: respuesta.success ? 'success' : 'error',
                title: respuesta.success ? 'xito' : 'Error',
                text: respuesta.message
            });
                // Recargar la lista de usuarios para ver los cambios
                cargarUsuarios(inicializarVistaUsuarios);
            }
        })
        .withFailureHandler(function(error) {
            ocultarModalCarga();
            Swal.fire({
                icon: 'error',
                title: 'Error al Actualizar',
                text: `Hubo un problema al actualizar el usuario: ${error.message}`
            });
        })
        .actualizarUsuario(datosActualizados);
}
/**
 * Limpia todos los campos del formulario y elimina los campos inyectados.
 */
function limpiarFormulario() {
    document.getElementById('emailUsuario').value = '';
    document.getElementById('nombreUsuario').value = '';
    
    // Vuelve el selector de rol a la opci贸n por defecto
    const rolSelector = document.getElementById('rolUsuario');
    rolSelector.selectedIndex = 0;

    // Elimina los campos inyectados para el rol de 'Encargado'
    const campoIdEncargado = document.getElementById('campoIdEncargado');
    const campoTelefonoEncargado = document.getElementById('campoTelefonoEncargado');
    if (campoIdEncargado) {
        campoIdEncargado.remove();
    }
    if (campoTelefonoEncargado) {
        campoTelefonoEncargado.remove();
    }
}
/**
 * Muestra un mensaje tras guardar un usuario utilizando SweetAlert2.
 * @param {Object} resultado - Respuesta del servidor.
 */
function mostrarMensajeUsuario(resultado) {
  if (resultado.success) {
    mostrarAlerta('success', 'Usuario guardado', resultado.message);
    // Limpiar formulario
    document.getElementById('emailUsuario').value = '';
    document.getElementById('nombreUsuario').value = '';
    document.getElementById('rolUsuario').value = 'Docente';
    document.getElementById('accesosUsuario').value = '';
  } else {
    mostrarAlerta('error', 'Error', resultado.message);
  }
}

/**
 * Muestra una alerta general con SweetAlert2.
 * @param {'success'|'error'|'warning'|'info'|'question'} icon - Tipo de icono.
 * @param {string} title - T铆tulo de la alerta.
 * @param {string} text - Texto descriptivo.
 * @param {string} [confirmText='OK'] - Texto del bot贸n de confirmaci贸n.
 */
function mostrarAlerta(icon, title, text, confirmText = 'OK') {
  Swal.fire({
    icon: icon,
    title: title,
    text: text,
    confirmButtonText: confirmText
  });
}

/**
 * Carga usuarios desde el backend y ejecuta un callback con los datos.
 * @param {Function} callback - Funci贸n a ejecutar con los datos de usuarios.
 */
function cargarUsuarios(callback) {
  mostrarModalCarga();
  google.script.run
    .withSuccessHandler(function(respuesta) {
      if (Array.isArray(respuesta)) {
        ocultarModalCarga();
        renderizarUsuarios(respuesta);
        if (typeof callback === 'function') callback(respuesta);
      } else {
        renderizarUsuarios([]);
        if (typeof callback === 'function') callback([]);
      }
    })
    .withFailureHandler(function(error) {
      alert("Error al cargar usuarios");
      renderizarUsuarios([]);
    ocultarModalCarga();
      if (typeof callback === 'function') callback([]);
    })
    .obtenerTodoUsuarios();
}

/**
 * Renderiza la tabla de usuarios sin paginaci贸n (usado como fallback).
 * @param {Array<Object>} usuarios - Lista de usuarios a renderizar.
 */
function renderizarUsuarios(usuarios) {
  mostrarModalCarga();
  const tbody = document.getElementById('userListBody');
  if (!tbody) {
    ocultarModalCarga();
    return;
  }

  tbody.innerHTML = '';

  if (!Array.isArray(usuarios) || usuarios.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5">No hay usuarios registrados.</td></tr>';
    ocultarModalCarga();
    return;
  }

  usuarios.forEach(u => {
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td>${u.email || ''}</td>
      <td>${u.nombre || ''}</td>
      <td>${u.rol || ''}</td>
      <td>${Array.isArray(u.acceso) ? u.acceso.join(', ') : (u.acceso || '')}</td>
      <td><button onclick="editarUsuario('${u.email || ''}')">Editar</button></td>
    `;
    tbody.appendChild(fila);
  });

  ocultarModalCarga();
}

/**
 * Inicializa la vista de usuarios con b煤squeda y paginaci贸n.
 * @param {Array<Object>} usuarios - Lista de usuarios a mostrar.
 */
function inicializarVistaUsuarios(usuarios) {
  const usuariosPorPagina = 10;
  usuariosOriginales = usuarios;
  usuariosFiltrados = [...usuarios];
  paginaActual = 1;

  const buscador = document.getElementById('buscadorUsuarios');
  const btnPrev = document.getElementById('prevPagina');
  const btnNext = document.getElementById('nextPagina');
  const infoPagina = document.getElementById('infoPagina');
  const tbody = document.getElementById('userListBody');

  if (!buscador || !btnPrev || !btnNext || !infoPagina || !tbody) {
    return;
  }

  function mostrarPagina() {
    tbody.innerHTML = '';
    const inicio = (paginaActual - 1) * usuariosPorPagina;
    const fin = inicio + usuariosPorPagina;
    const pagina = usuariosFiltrados.slice(inicio, fin);

    if (pagina.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5">No hay usuarios para mostrar.</td></tr>';
      return;
    }

    pagina.forEach(u => {
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${u.email || ''}</td>
        <td>${u.nombre || ''}</td>
        <td>${u.rol || ''}</td>
        <td>${Array.isArray(u.acceso) ? u.acceso.join(', ') : (u.acceso || '')}</td>
        <td><button onclick="editarUsuario('${u.email || ''}')">Editar</button></td>
      `;
      tbody.appendChild(fila);
    });

    infoPagina.textContent = `P谩gina ${paginaActual} de ${Math.ceil(usuariosFiltrados.length / usuariosPorPagina)}`;
    ocultarModalCarga();
  }

  buscador.addEventListener('input', function() {
    const texto = this.value.toLowerCase();
    usuariosFiltrados = usuariosOriginales.filter(u =>
      (u.email || '').toLowerCase().includes(texto) ||
      (u.nombre || '').toLowerCase().includes(texto) ||
      (u.rol || '').toLowerCase().includes(texto)
    );
    paginaActual = 1;
    mostrarPagina();
  });

  btnPrev.addEventListener('click', () => {
    if (paginaActual > 1) {
      paginaActual--;
      mostrarPagina();
    }
  });

  btnNext.addEventListener('click', () => {
    const totalPaginas = Math.ceil(usuariosFiltrados.length / usuariosPorPagina);
    if (paginaActual < totalPaginas) {
      paginaActual++;
      mostrarPagina();
    }
  });

  mostrarPagina();
}

/**
 * Carga un m贸dulo desde el servidor y ejecuta inicializaci贸n espec铆fica.
 * @param {string} nombreVista - Nombre del m贸dulo a cargar.
 */
function abrirModulo(nombreVista) {
  mostrarModalCarga();
  google.script.run.withSuccessHandler(function(html) {
    document.getElementById("contenedorModulo").innerHTML = html;
    setTimeout(() => {
      switch (nombreVista) {
        case 'usuarios_UsuariosView':
          cargarUsuarios((usuarios) => {
            inicializarVistaUsuarios(usuarios);
          });
          break;
        default:
          ocultarModalCarga();
          break;
      }
    }, 50);
  }).abrirModuloGS(nombreVista);
}
/**
 * Maneja el cambio de rol en el formulario de usuario.
 * Inyecta campos din谩micamente seg煤n el rol seleccionado.
 * @param {string} rol - El rol seleccionado ('Administrador', 'Profesor', 'Encargado').
 */
function onRolUsuarioChange(rol) {
    const form = document.querySelector('.formulario-usuario-agregar');
    const accionesFormulario = document.querySelector('.acciones-formulario');
    const campoIdEncargado = document.getElementById('campoIdEncargado');
    const campoTelefonoEncargado = document.getElementById('campoTelefonoEncargado');

    // Ч PASO 1: Eliminar cualquier campo de 'Encargado' previamente inyectado para evitar duplicados.
    if (campoIdEncargado) {
        campoIdEncargado.remove();
    }
    if (campoTelefonoEncargado) {
        campoTelefonoEncargado.remove();
    }
    
    // Opcional: Si el 'panel de accesos' existe y no se necesita para ciertos roles, puedes ocultarlo.
    const seccionesChecklistDiv = document.getElementById('seccionesChecklist');
    if (seccionesChecklistDiv) {
        seccionesChecklistDiv.style.display = 'none'; // Por defecto, lo ocultamos.
    }

    // П PASO 2: L贸gica de inyecci贸n condicional para el rol de 'Encargado'.
    if (rol === 'Encargado') {
        // Campo de ID del encargado
        const nuevoCampoId = document.createElement('div');
        nuevoCampoId.id = 'campoIdEncargado';
        nuevoCampoId.classList.add('campo-form');
        nuevoCampoId.innerHTML = `
            <label for="idEncargado"><strong>ID del Encargado</strong></label>
            <input type="text" id="idEncargado" placeholder="Ingrese el ID o c\u00E9dula..." required />
        `;

        // Campo de Tel茅fono del encargado
        const nuevoCampoTelefono = document.createElement('div');
        nuevoCampoTelefono.id = 'campoTelefonoEncargado';
        nuevoCampoTelefono.classList.add('campo-form');
        nuevoCampoTelefono.innerHTML = `
            <label for="telefonoEncargado"><strong>Tel\u00E9fono del Encargado</strong></label>
            <input type="tel" id="telefonoEncargado" placeholder="Ingrese el n\u00FAmero de tel\u00E9fono..." required />
        `;

        // ★ Insertar los nuevos campos justo antes de los botones de acci贸n.
        form.insertBefore(nuevoCampoId, accionesFormulario);
        form.insertBefore(nuevoCampoTelefono, accionesFormulario);
    }
    // Para cualquier otro rol, la funci贸n ya se encarg贸 de eliminar los campos din谩micos en el Paso 1.
}
/**
 * Inicia el proceso de edici贸n de un usuario levantando un modal
 * con sus datos y accesos editables.
 *
 * @param {string} email - El email del usuario a editar.
 */
function editarUsuario(email) {
    // 1. Mostrar el modal de carga mientras buscamos al usuario
    mostrarModalCarga();

    // 2. Encontrar el usuario en la lista de usuarios.
    // Asumimos que `usuariosOriginales` es una variable global con todos los usuarios.
    const usuarioAEditar = usuariosOriginales.find(u => u.email === email);

    // Si el usuario no se encuentra, mostramos una alerta y salimos.
    if (!usuarioAEditar) {
        ocultarModalCarga();
        mostrarAlerta('error', 'Usuario no encontrado', 'No se pudo encontrar el usuario para editar.');
        return;
    }

    // 3. Rellenar el formulario del modal con los datos del usuario.
    const modal = document.getElementById('modalEdicionUsuario');
    if (modal) {
        // Rellenar campos b谩sicos
        modal.querySelector('#modalEmail').value = usuarioAEditar.email || '';
        modal.querySelector('#modalNombre').value = usuarioAEditar.nombre || '';
        modal.querySelector('#modalRol').value = usuarioAEditar.rol || '';
        modal.querySelector('#modalOriginalEmail').value = usuarioAEditar.email || '';
        
        // 4. Cargar y renderizar los accesos en el control de "tags" o "chips".
        const accesosUsuario = Array.isArray(usuarioAEditar.acceso) ? usuarioAEditar.acceso : (usuarioAEditar.acceso || '').split(',').map(s => s.trim()).filter(s => s);
        
        renderizarAccesosTags(accesosUsuario);

        // 5. Mostrar el modal y ocultar el modal de carga.
        modal.style.display = 'block';
        ocultarModalCarga();
    } else {
        ocultarModalCarga();
        mostrarAlerta('error', 'Error de Interfaz', 'No se encontr贸 el modal de edici贸n. Aseg煤rate de que el HTML est茅 en la p谩gina.');
    }
}

/**
 * Renderiza los accesos de un usuario como "tags" o "chips"
 * en el modal de edici贸n, permitiendo su eliminaci贸n.
 *
 * @param {Array<string>} accesos - El arreglo de accesos a renderizar.
 */
function renderizarAccesosTags(accesos) {
    const contenedorTags = document.getElementById('modalAccesosTags');
    contenedorTags.innerHTML = ''; // Limpia los tags anteriores
    
    accesos.forEach(acceso => {
        const tag = document.createElement('span');
        tag.classList.add('acceso-tag');
        tag.textContent = acceso;
        
        // Bot贸n para eliminar el tag
        const botonEliminar = document.createElement('button');
        botonEliminar.classList.add('eliminar-tag-btn');
        botonEliminar.textContent = 'x';
        botonEliminar.onclick = function() {
            tag.remove();
        };
        
        tag.appendChild(botonEliminar);
        contenedorTags.appendChild(tag);
    });
}
/**
 * Recopila los datos del formulario de edici贸n en el modal y los env铆a al servidor
 * para actualizar el registro del usuario.
 */
function actualizarUsuario() {
    const originalEmail = document.getElementById('modalOriginalEmail')?.value;
    const nuevoNombre = document.getElementById('modalNombre')?.value;
    const rol = document.getElementById('modalRol')?.value;
    
    // Recopilar los accesos del contenedor de tags (solo para roles que los usan)
    let accesosString = '';
    if (rol !== 'Encargado') {
        const accesosTags = document.querySelectorAll('#modalAccesosTags .acceso-tag');
        const accesosArray = Array.from(accesosTags).map(tag => tag.textContent.trim().replace('x', ''));
        accesosString = accesosArray.join(', ');
    }

    // Validar que el nombre no est茅 vac铆o
    if (!nuevoNombre.trim()) {
        mostrarAlerta('error', 'Nombre Requerido', 'Por favor, introduce un nombre para el usuario.');
        return;
    }

    mostrarModalCarga();
    
    const datosActualizados = {
        originalEmail: originalEmail,
        nuevoNombre: nuevoNombre,
        nuevosAccesos: accesosString,
        rol: rol // 猬锔 Nuevo: Enviamos el rol para que el servidor sepa qu茅 tabla actualizar.
    };

    google.script.run
.withSuccessHandler(function(respuesta) {
            ocultarModalCarga();
            
            Swal.fire({
                icon: respuesta.success ? 'success' : 'error',
                title: respuesta.success ? 'xito' : 'Error',
                text: respuesta.message
            }).then(() => {
                // 猬锔 Este bloque se ejecuta solo cuando el usuario hace clic en "OK"
                if (respuesta.success) {
                    // Cerrar el modal
                    document.getElementById('modalEdicionUsuario').style.display = 'none';
                    
                    // Recargar la lista de usuarios para ver los cambios
                    cargarUsuarios(inicializarVistaUsuarios);
                }
            });
        })
        .withFailureHandler(function(error) {
            ocultarModalCarga();
            mostrarAlerta('error', 'Error al Actualizar', `Hubo un problema al actualizar el usuario: ${error.message}`);
        })
        .actualizarUsuarioBackEnd(datosActualizados);
}
</script>